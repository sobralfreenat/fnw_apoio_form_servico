<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Acompanhamento - Serviços</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--primary-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            position: relative;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
        }

        .logo-container img {
            max-width: 200px;
            height: auto;
        }

        .accordion-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .accordion-header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .accordion-content {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .accordion-content.collapsed {
            display: none;
        }

        .accordion-icon {
            transition: transform 0.3s ease;
        }

        .accordion-icon.rotated {
            transform: rotate(180deg);
        }

        .form-header-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            font-size: 0.98em;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item label {
            font-size: 1em;
            font-weight: normal;
        }

        .checkbox-item input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .whatsapp-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .whatsapp-input-group input {
            flex: 1;
        }

        .whatsapp-preview {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-resolved {
            background-color: var(--success-color);
            color: white;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: var(--primary-color);
        }

        .status-budget {
            background-color: var(--danger-color);
            color: white;
        }

        /* Novo estilo para os itens de serviço */
        .form-section h2 {
            color: var(--primary-color);
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .servico-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }

        .servico-item label {
            font-size: 1.25em;
            color: var(--primary-color);
            font-weight: normal;
            margin-bottom: 10px;
            display: block;
        }

        .editable-label {
            font-size: 1.25em;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .editable-checkbox-label {
            cursor: pointer;
            border-bottom: 1px dashed #aaa;
            padding: 0 2px;
            transition: color 0.2s;
        }
        .editable-checkbox-label:hover {
            color: #3498db;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 5px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group-left,
            .button-group-right {
                width: 100%;
                justify-content: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .form-header-content {
                grid-template-columns: 1fr;
            }
        }

        .button-group-left .btn,
        .button-group-right .btn {
            margin-bottom: 12px;
        }
        .button-group-left .btn:last-child,
        .button-group-right .btn:last-child {
            margin-bottom: 0;
        }
    </style>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://www.sie.com.br/admin/_upload/2021/10/23/29155/665e0803ea26e.png" alt="Logo SIE" />
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
            <input type="file" id="fileInputTopo" accept=".json" style="display: none;" onchange="carregarJSON(event)">
            <button class="btn btn-primary" onclick="document.getElementById('fileInputTopo').click()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Carregar JSON
            </button>
            <button class="btn btn-primary" onclick="salvarJSON()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Salvar JSON
            </button>
            <button class="btn btn-danger" onclick="reiniciarVazio()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M5 13h14v-2H5v2zm7-12C6.48 1 1 6.48 1 13s5.48 12 12 12 12-5.48 12-12S17.52 1 12 1zm0 22c-5.52 0-10-4.48-10-10S6.48 3 12 3s10 4.48 10 10-4.48 10-10 10z"/>
                </svg>
                Reiniciar Vazio
            </button>
        </div>

        <div class="accordion-header" onclick="toggleAccordion()">
            <h1>Formulário de Acompanhamento - Serviços</h1>
            <svg class="accordion-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 10l5 5 5-5z"/>
            </svg>
        </div>

        <div class="accordion-content" id="headerContent">
            <div class="form-header-content">
                <div class="form-group">
                    <label for="dataAtendimento">Data do atendimento:</label>
                    <input type="date" id="dataAtendimento" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="horario">Horário:</label>
                    <input type="time" id="horario" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="responsavel">Responsável pelo atendimento:</label>
                    <input type="text" id="responsavel" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="whatsapp">Número do WhatsApp para contato:</label>
                    <div class="whatsapp-input-group" style="flex-direction:column;align-items:stretch;gap:8px;">
                        <input type="tel" id="whatsapp" class="form-control" placeholder="(00) 00000-0000" 
                               pattern="\([0-9]{2}\) [0-9]{5}-[0-9]{4}" required>
                        <button class="btn btn-whatsapp" style="width:100%;max-width:220px;align-self:center;" onclick="enviarWhatsApp()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            Enviar
                        </button>
                    </div>
                    <div class="whatsapp-preview" id="whatsappPreview"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2>Serviços a realizar</h2>
            <div class="form-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novoServico" class="form-control" placeholder="Adicionar novo serviço...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('servicos')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('servicos')" title="Excluir todos os serviços">X</button>
            </div>
            <div id="servicosContainer">
                <!-- Serviços serão inseridos aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2>Dúvidas a esclarecer</h2>
            <div class="form-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novaDuvida" class="form-control" placeholder="Adicionar nova dúvida...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('duvidas')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('duvidas')" title="Excluir todas as dúvidas">X</button>
            </div>
            <div id="duvidasContainer">
                <!-- Dúvidas serão inseridas aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2 id="tituloLuzes" style="cursor:pointer;" onclick="editarTituloLuzes()">Luzes externas</h2>
            <div class="form-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novaLuz" class="form-control" placeholder="Adicionar nova luz...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('luzes')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('luzes')" title="Excluir todas as luzes">X</button>
            </div>
            <div id="luzesContainer">
                <!-- Luzes serão inseridas aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2>Outros</h2>
            <div class="form-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novoOutro" class="form-control" placeholder="Adicionar novo item em Outros...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('outros')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('outros')" title="Excluir todos os outros">X</button>
            </div>
            <div id="outrosContainer">
                <!-- Outros itens serão inseridos aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2>Observações gerais</h2>
            <div class="form-group">
                <textarea id="observacoes" class="form-control" rows="4"></textarea>
            </div>
        </div>

        <div class="form-section">
            <div class="button-group">
                <div class="button-group-left">
                    <button class="btn btn-primary" onclick="salvarFormulario()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Salvar Formulário
                    </button>
                </div>
                <div class="button-group-right">
                    <button class="btn btn-success" onclick="exportarPDF()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Listas dinâmicas
        let servicos = [
            "Luz da cozinha piscando",
            "Luz automática da escada não acende",
            "Luz do banheiro da frente não acende",
            "Vazamento de água no vaso do banheiro da frente",
            "Trinco da porta da edícula de cima",
            "Registro do banheiro da edícula pingando",
            "Umidade no teto da edícula de cima (conserto do rufo)",
            "Janelas emperrando"
        ];
        let duvidas = [
            "Quando a caixa foi limpa e como acessá-la",
            "Como funciona o gás do chuveiro (não aqueceu)",
            "Pode transformar o chuveiro para elétrico"
        ];
        let luzes = [
            "Luz da churrasqueira (primeira da direita)",
            "Outras luzes de fora, lado esquerdo",
            "Luz do terraço (última à esquerda para quem olha para a rua)"
        ];
        let outros = [
            "Elétrica da edícula ok para instalar chuveiro",
            "Descargas banheiro da frente e edícula (vazamento no mecanismo)"
        ];

        // Variável para o título editável
        let tituloLuzes = 'Luzes externas';

        // Exemplo padrão para cada seção
        const exemploServicos = ['Exemplo de serviço...'];
        const exemploDuvidas = ['Exemplo de dúvida...'];
        const exemploLuzes = ['Exemplo de luz...'];
        const exemploOutros = ['Exemplo de outro item...'];
        const exemploLabelsLuzes = ['Lâmpada', 'Fiação', 'Outro'];

        // Função para criar um item de serviço
        function criarItemServico(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'servicos', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'servicos', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'servicos', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('servicos', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"resolvido\" id=\"resolvido_${descricao}\">
                        <label for=\"resolvido_${descricao}\">Resolvido</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"nao_resolvido\" id=\"nao_resolvido_${descricao}\">
                        <label for=\"nao_resolvido_${descricao}\">Não resolvido</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"orcamento\" id=\"orcamento_${descricao}\">
                        <label for=\"orcamento_${descricao}\">Orçamento necessário</label>
                    </div>
                </div>
            `;
            return div;
        }

        // Função para criar um item de dúvida
        function criarItemDuvida(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'duvidas', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'duvidas', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'duvidas', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('duvidas', ${idx})">X</button>
                    </div>
                </div>
                <textarea class=\"form-control\" rows=\"2\" placeholder=\"${descricao}\"></textarea>
            `;
            return div;
        }

        // Função para criar um item de luz
        function criarItemLuz(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'luzes', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'luzes', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'luzes', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('luzes', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"lampada_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,0)\">${luzesLabels[0]}</span>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"fiacao_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,1)\">${luzesLabels[1]}</span>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"outro_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,2)\">${luzesLabels[2]}</span>
                    </div>
                </div>
            `;
            return div;
        }

        // Função para criar um item de outros
        function criarItemOutros(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'outros', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'outros', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'outros', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('outros', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"sim\" id=\"sim_${descricao}\">
                        <label for=\"sim_${descricao}\">Sim</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"nao\" id=\"nao_${descricao}\">
                        <label for=\"nao_${descricao}\">Não</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"obs\" id=\"obs_${descricao}\">
                        <label for=\"obs_${descricao}\">Observações</label>
                    </div>
                </div>
            `;
            return div;
        }

        // Função para atualizar data e hora
        function atualizarDataHora() {
            const agora = new Date();
            
            // Formatar data (YYYY-MM-DD)
            const data = agora.toISOString().split('T')[0];
            
            // Formatar hora (HH:MM)
            const hora = agora.toTimeString().slice(0, 5);
            
            // Atualizar campos
            document.getElementById('dataAtendimento').value = data;
            document.getElementById('horario').value = hora;
        }

        // Função para formatar nome do arquivo
        function formatarNomeArquivo() {
            const responsavel = document.getElementById('responsavel').value.trim();
            const data = document.getElementById('dataAtendimento').value;
            const hora = document.getElementById('horario').value;
            
            // Remover caracteres especiais do nome do responsável
            const nomeFormatado = responsavel
                .replace(/[^a-zA-Z0-9]/g, '_')
                .toLowerCase();
            
            // Formatar data e hora para o nome do arquivo
            const dataFormatada = data.replace(/-/g, '');
            const horaFormatada = hora.replace(/:/g, '');
            
            return `formulario_${nomeFormatado}_${dataFormatada}_${horaFormatada}.json`;
        }

        // Função para alternar o acordeão
        function toggleAccordion() {
            const content = document.getElementById('headerContent');
            const icon = document.querySelector('.accordion-icon');
            content.classList.toggle('collapsed');
            icon.classList.toggle('rotated');
        }

        // Função para adicionar itens dinamicamente
        function adicionarItem(tipo) {
            let inputId, arr;
            if (tipo === 'servicos') {
                inputId = 'novoServico'; arr = servicos;
            } else if (tipo === 'duvidas') {
                inputId = 'novaDuvida'; arr = duvidas;
            } else if (tipo === 'luzes') {
                inputId = 'novaLuz'; arr = luzes;
            } else if (tipo === 'outros') {
                inputId = 'novoOutro'; arr = outros;
            }
            const input = document.getElementById(inputId);
            const valor = input.value.trim();
            if (valor && !arr.includes(valor)) {
                arr.push(valor);
                input.value = '';
                inicializarFormulario();
            }
        }

        // Função para inicializar o formulário
        function inicializarFormulario() {
            const servicosContainer = document.getElementById('servicosContainer');
            const duvidasContainer = document.getElementById('duvidasContainer');
            const luzesContainer = document.getElementById('luzesContainer');
            const outrosContainer = document.getElementById('outrosContainer');

            // Limpar containers
            servicosContainer.innerHTML = '';
            duvidasContainer.innerHTML = '';
            luzesContainer.innerHTML = '';
            outrosContainer.innerHTML = '';

            // Atualizar data e hora inicial
            atualizarDataHora();

            // Configurar atualização automática da hora a cada minuto
            setInterval(atualizarDataHora, 60000);

            servicos.forEach((servico, idx) => {
                servicosContainer.appendChild(criarItemServico(servico, idx));
            });

            duvidas.forEach((duvida, idx) => {
                duvidasContainer.appendChild(criarItemDuvida(duvida, idx));
            });

            luzes.forEach((luz, idx) => {
                luzesContainer.appendChild(criarItemLuz(luz, idx));
            });

            outros.forEach((outro, idx) => {
                outrosContainer.appendChild(criarItemOutros(outro, idx));
            });

            // Atualizar título da seção Luzes externas
            const h2 = document.getElementById('tituloLuzes');
            if (h2) h2.textContent = tituloLuzes;
        }

        // Função para salvar o formulário como JSON
        function salvarJSON() {
            const formData = coletarDadosFormulario();
            const dataStr = JSON.stringify(formData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = formatarNomeArquivo();
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Função para carregar JSON
        function carregarJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const formData = JSON.parse(e.target.result);
                        preencherFormulario(formData);
                    } catch (error) {
                        alert('Erro ao carregar o arquivo JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        // Função para coletar dados do formulário
        function coletarDadosFormulario() {
            const formData = {
                dataAtendimento: document.getElementById('dataAtendimento').value,
                horario: document.getElementById('horario').value,
                responsavel: document.getElementById('responsavel').value,
                whatsapp: document.getElementById('whatsapp').value,
                observacoes: document.getElementById('observacoes').value,
                servicos: {},
                duvidas: {},
                luzes: {},
                outros: {},
                listaServicos: servicos,
                listaDuvidas: duvidas,
                listaLuzes: luzes,
                listaOutros: outros,
                tituloLuzes: tituloLuzes,
                luzesLabels: luzesLabels
            };

            // Coletar dados dos serviços
            servicos.forEach(servico => {
                const status = document.querySelector(`input[name="status_${servico}"]:checked`)?.value;
                formData.servicos[servico] = status;
            });

            // Coletar dados das dúvidas
            duvidas.forEach(duvida => {
                const textarea = document.querySelector(`textarea[placeholder="${duvida}"]`);
                formData.duvidas[duvida] = textarea ? textarea.value : '';
            });

            // Coletar dados das luzes
            luzes.forEach(luz => {
                formData.luzes[luz] = {
                    lampada: document.getElementById(`lampada_${luz}`)?.checked || false,
                    fiacao: document.getElementById(`fiacao_${luz}`)?.checked || false,
                    outro: document.getElementById(`outro_${luz}`)?.checked || false
                };
            });

            // Coletar dados dos outros
            outros.forEach(outro => {
                const status = document.querySelector(`input[name="status_${outro}"]:checked`)?.value;
                formData.outros[outro] = status;
            });

            return formData;
        }

        // Função para preencher o formulário com dados carregados
        function preencherFormulario(formData) {
            // Preencher listas dinâmicas se existirem
            if (formData.listaServicos) servicos = formData.listaServicos;
            if (formData.listaDuvidas) duvidas = formData.listaDuvidas;
            if (formData.listaLuzes) luzes = formData.listaLuzes;
            if (formData.listaOutros) outros = formData.listaOutros;
            if (formData.tituloLuzes) tituloLuzes = formData.tituloLuzes;
            if (formData.luzesLabels) luzesLabels = formData.luzesLabels;
            // Garantir pelo menos um exemplo
            if (!servicos || servicos.length === 0) servicos = [...exemploServicos];
            if (!duvidas || duvidas.length === 0) duvidas = [...exemploDuvidas];
            if (!luzes || luzes.length === 0) luzes = [...exemploLuzes];
            if (!outros || outros.length === 0) outros = [...exemploOutros];
            // Preencher dados básicos
            document.getElementById('dataAtendimento').value = formData.dataAtendimento || '';
            document.getElementById('horario').value = formData.horario || '';
            document.getElementById('responsavel').value = formData.responsavel || '';
            document.getElementById('whatsapp').value = formData.whatsapp || '';
            atualizarPreviewWhatsApp();
            document.getElementById('observacoes').value = formData.observacoes || '';

            // Preencher serviços
            Object.entries(formData.servicos || {}).forEach(([servico, status]) => {
                const radio = document.querySelector(`input[name="status_${servico}"][value="${status}"]`);
                if (radio) radio.checked = true;
            });

            // Preencher dúvidas
            Object.entries(formData.duvidas || {}).forEach(([duvida, resposta]) => {
                const textarea = document.querySelector(`textarea[placeholder="${duvida}"]`);
                if (textarea) textarea.value = resposta;
            });

            // Preencher luzes
            Object.entries(formData.luzes || {}).forEach(([luz, dados]) => {
                if (dados.lampada) document.getElementById(`lampada_${luz}`).checked = true;
                if (dados.fiacao) document.getElementById(`fiacao_${luz}`).checked = true;
                if (dados.outro) document.getElementById(`outro_${luz}`).checked = true;
            });

            // Preencher outros
            Object.entries(formData.outros || {}).forEach(([outro, status]) => {
                const radio = document.querySelector(`input[name="status_${outro}"][value="${status}"]`);
                if (radio) radio.checked = true;
            });

            inicializarFormulario();
        }

        // Função para salvar o formulário
        function salvarFormulario() {
            const formData = coletarDadosFormulario();
            localStorage.setItem('formularioServicos', JSON.stringify(formData));
            alert('Formulário salvo com sucesso!');
        }

        // Função para exportar PDF
        function exportarPDF() {
            const formData = coletarDadosFormulario();
            const doc = new window.jspdf.jsPDF();
            let y = 15;
            doc.setFontSize(16);
            doc.text('Formulário de Acompanhamento - Serviços', 10, y);
            y += 10;
            doc.setFontSize(12);
            doc.text(`Data do atendimento: ${formData.dataAtendimento || ''}`, 10, y);
            y += 7;
            doc.text(`Horário: ${formData.horario || ''}`, 10, y);
            y += 7;
            doc.text(`Responsável: ${formData.responsavel || ''}`, 10, y);
            y += 7;
            doc.text(`WhatsApp: ${formData.whatsapp || ''}`, 10, y);
            y += 10;
            doc.setFontSize(14);
            doc.text('Serviços a realizar:', 10, y);
            y += 8;
            doc.setFontSize(12);
            Object.entries(formData.servicos).forEach(([serv, status]) => {
                doc.text(`- ${serv}: ${status || ''}`, 12, y);
                y += 6;
            });
            y += 4;
            doc.setFontSize(14);
            doc.text('Dúvidas a esclarecer:', 10, y);
            y += 8;
            doc.setFontSize(12);
            Object.entries(formData.duvidas).forEach(([duv, resp]) => {
                doc.text(`- ${duv}: ${resp || ''}`, 12, y);
                y += 6;
            });
            y += 4;
            doc.setFontSize(14);
            doc.text('Luzes externas:', 10, y);
            y += 8;
            doc.setFontSize(12);
            Object.entries(formData.luzes).forEach(([luz, obj]) => {
                doc.text(`- ${luz}: Lâmpada: ${obj.lampada ? 'Sim' : 'Não'}, Fiação: ${obj.fiacao ? 'Sim' : 'Não'}, Outro: ${obj.outro ? 'Sim' : 'Não'}`, 12, y);
                y += 6;
            });
            y += 4;
            doc.setFontSize(14);
            doc.text('Outros:', 10, y);
            y += 8;
            doc.setFontSize(12);
            Object.entries(formData.outros).forEach(([outro, status]) => {
                doc.text(`- ${outro}: ${status || ''}`, 12, y);
                y += 6;
            });
            y += 8;
            doc.setFontSize(14);
            doc.text('Observações gerais:', 10, y);
            y += 8;
            doc.setFontSize(12);
            doc.text(formData.observacoes || '', 12, y);
            // Salvar PDF
            doc.save('formulario_servicos.pdf');
        }

        // Função para carregar do localStorage ao iniciar
        function carregarDoLocalStorage() {
            const savedData = localStorage.getItem('formularioServicos');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    // Não sobrescrever data e hora ao carregar
                    const dataAtual = document.getElementById('dataAtendimento').value;
                    const horaAtual = document.getElementById('horario').value;
                    preencherFormulario(formData);
                    document.getElementById('dataAtendimento').value = dataAtual;
                    document.getElementById('horario').value = horaAtual;
                } catch (error) {
                    console.error('Erro ao carregar dados do localStorage:', error);
                }
            }
        }

        // Função para formatar número de WhatsApp
        function formatarWhatsApp(numero) {
            return numero.replace(/\D/g, '');
        }

        // Função para validar número de WhatsApp
        function validarWhatsApp(numero) {
            const numeroLimpo = formatarWhatsApp(numero);
            return numeroLimpo.length >= 10 && numeroLimpo.length <= 11;
        }

        // Função para atualizar preview do WhatsApp
        function atualizarPreviewWhatsApp() {
            const numero = document.getElementById('whatsapp').value;
            const numeroLimpo = formatarWhatsApp(numero);
            const preview = document.getElementById('whatsappPreview');
            
            if (validarWhatsApp(numero)) {
                preview.textContent = `Link do WhatsApp: https://wa.me/55${numeroLimpo}`;
                preview.style.color = 'var(--success-color)';
            } else {
                preview.textContent = 'Número inválido';
                preview.style.color = 'var(--danger-color)';
            }
        }

        // Função para enviar WhatsApp
        function enviarWhatsApp() {
            const numero = document.getElementById('whatsapp').value;
            const numeroLimpo = formatarWhatsApp(numero);
            
            if (validarWhatsApp(numero)) {
                const formData = coletarDadosFormulario();
                const mensagem = `Formulário de Serviços\n\n` +
                    `Data: ${formData.dataAtendimento}\n` +
                    `Horário: ${formData.horario}\n` +
                    `Responsável: ${formData.responsavel}\n\n` +
                    `Observações: ${formData.observacoes}`;
                
                const url = `https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(mensagem)}`;
                window.open(url, '_blank');
            } else {
                alert('Por favor, insira um número de WhatsApp válido');
            }
        }

        // Adicionar evento de input para o campo de WhatsApp
        document.getElementById('whatsapp').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 2) {
                value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
            }
            if (value.length > 9) {
                value = `${value.slice(0, 9)}-${value.slice(9)}`;
            }
            
            e.target.value = value;
            atualizarPreviewWhatsApp();
        });

        // Função de confirmação antes de remover
        function confirmarRemoverItem(tipo, idx) {
            const acao = prompt('Digite 1 para excluir apenas este item, 2 para excluir TODOS os itens, ou qualquer outra tecla para cancelar.');
            if (acao === '1') {
                if (confirm('Tem certeza que deseja excluir este item?')) {
                    removerItem(tipo, idx);
                }
            } else if (acao === '2') {
                confirmarRemoverTodos(tipo);
            }
        }

        function confirmarRemoverTodos(tipo) {
            let msg = 'Tem certeza que deseja excluir TODOS os itens desta seção?';
            if (confirm(msg)) {
                removerTodos(tipo);
            }
        }

        function removerTodos(tipo) {
            if (tipo === 'servicos') servicos = [];
            else if (tipo === 'duvidas') duvidas = [];
            else if (tipo === 'luzes') luzes = [];
            else if (tipo === 'outros') outros = [];
            inicializarFormulario();
        }

        // RemoverItem agora não precisa mais de prompt
        function removerItem(tipo, idx) {
            let arr;
            if (tipo === 'servicos') arr = servicos;
            else if (tipo === 'duvidas') arr = duvidas;
            else if (tipo === 'luzes') arr = luzes;
            else if (tipo === 'outros') arr = outros;
            arr.splice(idx, 1);
            inicializarFormulario();
        }

        // Drag and drop handlers
        let dragSrcIdx = null;
        let dragSrcTipo = null;
        function dragStart(e, tipo, idx) {
            dragSrcIdx = idx;
            dragSrcTipo = tipo;
            e.dataTransfer.effectAllowed = 'move';
        }
        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        function dropItem(e, tipo, idx) {
            e.preventDefault();
            if (dragSrcTipo === tipo && dragSrcIdx !== null && dragSrcIdx !== idx) {
                let arr;
                if (tipo === 'servicos') arr = servicos;
                else if (tipo === 'duvidas') arr = duvidas;
                else if (tipo === 'luzes') arr = luzes;
                else if (tipo === 'outros') arr = outros;
                const item = arr.splice(dragSrcIdx, 1)[0];
                arr.splice(idx, 0, item);
                inicializarFormulario();
            }
            dragSrcIdx = null;
            dragSrcTipo = null;
        }

        // Edição inline
        function editarItem(span, tipo, idx) {
            const valorAtual = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = valorAtual;
            input.className = 'form-control';
            input.style.display = 'inline-block';
            input.style.width = 'auto';
            input.style.maxWidth = '300px';
            input.onblur = function() { salvarEdicao(this, tipo, idx); };
            input.onkeydown = function(e) { if (e.key === 'Enter') { this.blur(); } };
            span.replaceWith(input);
            input.focus();
        }
        function salvarEdicao(input, tipo, idx) {
            let arr;
            if (tipo === 'servicos') arr = servicos;
            else if (tipo === 'duvidas') arr = duvidas;
            else if (tipo === 'luzes') arr = luzes;
            else if (tipo === 'outros') arr = outros;
            arr[idx] = input.value.trim() || arr[idx];
            inicializarFormulario();
        }

        // Função para editar o título da seção Luzes externas
        function editarTituloLuzes() {
            const h2 = document.getElementById('tituloLuzes');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = tituloLuzes;
            input.className = 'form-control';
            input.style.fontSize = '1.5em';
            input.style.fontWeight = 'bold';
            input.onblur = function() { salvarTituloLuzes(this.value); };
            input.onkeydown = function(e) { if (e.key === 'Enter') { this.blur(); } };
            h2.replaceWith(input);
            input.focus();
        }
        function salvarTituloLuzes(valor) {
            tituloLuzes = valor.trim() || 'Luzes externas';
            const input = document.querySelector('input.form-control[style*="font-size: 1.5em"]');
            if (input) {
                const h2 = document.createElement('h2');
                h2.id = 'tituloLuzes';
                h2.style.cursor = 'pointer';
                h2.onclick = editarTituloLuzes;
                h2.textContent = tituloLuzes;
                input.replaceWith(h2);
            }
        }

        // Função para reiniciar o formulário vazio
        function reiniciarVazio() {
            if (confirm('Tem certeza que deseja reiniciar o formulário vazio? Todos os dados serão perdidos!')) {
                servicos = [...exemploServicos];
                duvidas = [...exemploDuvidas];
                luzes = [...exemploLuzes];
                outros = [...exemploOutros];
                luzesLabels = [...exemploLabelsLuzes];
                tituloLuzes = 'Luzes externas';
                document.getElementById('dataAtendimento').value = '';
                document.getElementById('horario').value = '';
                document.getElementById('responsavel').value = '';
                document.getElementById('whatsapp').value = '';
                document.getElementById('observacoes').value = '';
                inicializarFormulario();
            }
        }

        // Labels editáveis para luzes
        let luzesLabels = [...exemploLabelsLuzes];

        function criarItemLuz(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'luzes', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'luzes', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'luzes', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('luzes', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"lampada_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,0)\">${luzesLabels[0]}</span>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"fiacao_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,1)\">${luzesLabels[1]}</span>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"outro_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,2)\">${luzesLabels[2]}</span>
                    </div>
                </div>
            `;
            return div;
        }

        function editarLabelLuz(span, idx) {
            const valorAtual = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = valorAtual;
            input.className = 'form-control';
            input.style.display = 'inline-block';
            input.style.width = 'auto';
            input.style.maxWidth = '120px';
            input.onblur = function() { salvarLabelLuz(this, idx); };
            input.onkeydown = function(e) { if (e.key === 'Enter') { this.blur(); } };
            span.replaceWith(input);
            input.focus();
        }
        function salvarLabelLuz(input, idx) {
            luzesLabels[idx] = input.value.trim() || exemploLabelsLuzes[idx];
            inicializarFormulario();
        }

        // Atualizar inicialização para exibir o título editável
        function inicializarFormulario() {
            const servicosContainer = document.getElementById('servicosContainer');
            const duvidasContainer = document.getElementById('duvidasContainer');
            const luzesContainer = document.getElementById('luzesContainer');
            const outrosContainer = document.getElementById('outrosContainer');
            // Limpar containers
            servicosContainer.innerHTML = '';
            duvidasContainer.innerHTML = '';
            luzesContainer.innerHTML = '';
            outrosContainer.innerHTML = '';
            // Atualizar título da seção Luzes externas
            const h2 = document.getElementById('tituloLuzes');
            if (h2) h2.textContent = tituloLuzes;
            // Atualizar data e hora inicial
            atualizarDataHora();
            // Configurar atualização automática da hora a cada minuto
            setInterval(atualizarDataHora, 60000);
            servicos.forEach((servico, idx) => {
                servicosContainer.appendChild(criarItemServico(servico, idx));
            });
            duvidas.forEach((duvida, idx) => {
                duvidasContainer.appendChild(criarItemDuvida(duvida, idx));
            });
            luzes.forEach((luz, idx) => {
                luzesContainer.appendChild(criarItemLuz(luz, idx));
            });
            outros.forEach((outro, idx) => {
                outrosContainer.appendChild(criarItemOutros(outro, idx));
            });
        }

        // Atualizar a inicialização
        window.onload = function() {
            inicializarFormulario();
            carregarDoLocalStorage();
            atualizarPreviewWhatsApp();
        };
    </script>
</body>
</html> 
