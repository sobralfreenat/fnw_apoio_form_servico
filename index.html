<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Acompanhamento - Serviços</title>
    <style>
        :root {
            --primary-color: #576361;
            --secondary-color: #2e3124;
            --success-color: #056576;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --light-bg: #e3f1f2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--primary-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            position: relative;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
        }

        .logo-container img {
            max-width: 200px;
            height: auto;
        }

        .accordion-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .accordion-header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .accordion-content {
            background-color: var(--primary-color);
            color: white;
            padding: 20px; /* Padding geral */
            border-radius: 8px;
            transition: all 0.3s ease;
            overflow: hidden; /* Esconde conteúdo que transborda quando colapsado */
            position: relative; /* Contexto para o dropdown em desktop */
        }

        .accordion-content.collapsed {
            display: none;
        }

        .accordion-icon {
            transition: transform 0.3s ease;
        }

        .accordion-icon.rotated {
            transform: rotate(180deg);
        }

        .form-header-content {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            grid-template-rows: auto auto auto;
            gap: 10px 15px;
            align-items: end;
        }

        .form-header-content > .form-group {
            grid-column: auto / auto;
        }

        .form-header-content > .form-group:nth-child(1) {
            grid-column: 1 / 2;
            grid-row: 1;
        }
        .form-header-content > .form-group:nth-child(2) {
            grid-column: 2 / 3;
            grid-row: 1;
        }
        .form-header-content > .form-group:nth-child(4) {
            grid-column: 1 / 4;
            grid-row: 2;
        }
        .form-header-content > .form-group:nth-child(3) {
            grid-column: 1 / 2;
            grid-row: 3;
        }
        .form-header-content > .form-group:nth-child(5) {
            grid-column: 2 / 4;
            grid-row: 3;
        }

        .form-header-content .whatsapp-input-group {
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-end !important;
            gap: 10px !important;
            width: 100%;
        }

        .form-header-content .whatsapp-input-group input#whatsapp {
            flex-grow: 1;
        }

        .form-header-content .whatsapp-input-group .btn-whatsapp {
            width: auto !important;
            max-width: none !important;
            align-self: flex-end !important;
            margin-bottom: 0 !important;
            flex-shrink: 0;
        }

        .form-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            font-size: 0.98em;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item label {
            font-size: 1em;
            font-weight: normal;
        }

        .checkbox-item input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .whatsapp-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .whatsapp-input-group input {
            flex: 1;
        }

        .whatsapp-preview {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-resolved {
            background-color: var(--success-color);
            color: white;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: var(--primary-color);
        }

        .status-budget {
            background-color: var(--danger-color);
            color: white;
        }

        /* Novo estilo para os itens de serviço */
        .form-section h2 {
            color: var(--primary-color);
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .servico-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }

        .servico-item label {
            font-size: 1.25em;
            color: var(--primary-color);
            font-weight: normal;
            margin-bottom: 10px;
            display: block;
        }

        .editable-label {
            font-size: 1.25em;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .editable-checkbox-label {
            cursor: pointer;
            border-bottom: 1px dashed #aaa;
            padding: 0 2px;
            transition: color 0.2s;
        }
        .editable-checkbox-label:hover {
            color: #3498db;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .logo-container img {
                max-width: 150px;
            }

            .top-action-buttons {
                /* Em mobile, será o primeiro item no fluxo do headerContent */
                /* Em desktop, será posicionado absolutamente */
                margin-bottom: 20px; /* Espaçamento padrão, principalmente para mobile */
                display: flex; /* Adicionado para mobile */
                justify-content: flex-end; /* Adicionado para alinhar o botão à direita em mobile */
            }
            /* .dropdown-container e .dropbtn em mobile já estão configurados para width 100% */

            .accordion-content#headerContent {
                 /* Em mobile, não é grid, elementos fluem normalmente */
            }
            .top-action-buttons .btn { /* Esta regra se aplica ao .dropbtn em mobile */
                width: auto; /* Alterado de 100% para auto em mobile */
                margin-bottom: 0; /* Removido o margin-bottom que era para botões empilhados */
                /* justify-content: center; Removido, não mais necessário com width:auto e flex-end no pai */
            }
            .top-action-buttons .btn:last-child {
                margin-bottom: 0;
            }

            .accordion-header h1 {
                font-size: 1.3em;
            }
            .form-section h2 {
                font-size: 1.3em;
            }

            .add-item-group {
                flex-direction: column;
                align-items: stretch;
            }
            .add-item-group .form-control {
                margin-bottom: 8px;
            }
            .add-item-group .btn {
                width: 100%;
                justify-content: center;
            }
            
            .servico-item label,
            .editable-label {
                font-size: 1.1em;
            }

            .form-section,
            .accordion-header,
            .accordion-content {
                margin-bottom: 15px;
            }

            .checkbox-group {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group-left,
            .button-group-right {
                width: 100%;
                justify-content: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            /* Removida a regra que alterava o grid-template-columns para 1fr no mobile */
            /* .form-header-content {
                grid-template-columns: 1fr;
            } */
        }

        .button-group-left .btn,
        .button-group-right .btn {
            margin-bottom: 12px;
        }
        .button-group-left .btn:last-child,
        .button-group-right .btn:last-child {
            margin-bottom: 0;
        }

        .top-action-buttons {
            /* Estilos gerais para o container do dropdown */
            /* Em mobile, ele será o primeiro item no fluxo normal do headerContent */
            margin-bottom: 15px; /* Espaçamento abaixo do dropdown antes dos campos, principalmente para mobile */
        }

        .add-item-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Dropdown Button Styles */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropbtn {
            /* Herda estilos de .btn e .btn-primary */
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: center; /* Centraliza texto e ícone */
        }

        .dropdown-caret {
            margin-left: 8px;
            font-size: 0.8em;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px; /* Ajuste conforme necessário */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100;
            border-radius: 4px;
        }

        .dropdown-content a {
            color: var(--primary-color);
            padding: 12px 16px;
            text-decoration: none;
            display: flex; /* Para alinhar ícone e texto */
            align-items: center;
            gap: 8px; /* Espaço entre ícone e texto */
        }
        .dropdown-content a svg {
             fill: var(--primary-color);
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        .dropdown-content.show {
            display: block;
        }

        /* Desktop-specific overrides */
        @media (min-width: 601px) {
            .accordion-content#headerContent:not(.collapsed) {
                display: grid;
                grid-template-columns: 1fr auto; /* Coluna flex para campos, Coluna auto para dropdown */
                grid-template-rows: auto 1fr;    /* Linha auto para dropdown, Linha flex para campos */
                gap: 0 20px; /* Sem gap de linha, gap de coluna entre campos e dropdown se estivessem lado a lado */
                /* padding: 20px; Mantido do .accordion-content geral */
            }

            .accordion-content#headerContent:not(.collapsed) > .top-action-buttons {
                position: absolute;
                top: 10px; /* Reduzido de 20px para diminuir o espaço acima */
                right: 35px; /* Aumentado de 20px para criar mais espaço à direita */
                z-index: 10; /* Para sobrepor outros elementos se necessário */
                margin-bottom: 0; /* Remove a margem que é para mobile */
            }

            .accordion-content#headerContent:not(.collapsed) > .form-header-content {
                grid-column: 1 / 2;  /* Na primeira coluna (ocupa a largura menos o dropdown) */
                grid-row: 1 / 3;     /* Ocupa ambas as linhas para se estender ao lado e abaixo do dropdown */
                                     /* Se o dropdown for muito alto, isso pode precisar de ajuste, 
                                        ou fazer o form-header-content ser 1 / span 2 na linha 2 */ 
                /* Ajuste proposto: Colocar campos na linha 2 para clareza */
                /* grid-column: 1 / 3; /* Ocupa toda a largura */
                /* grid-row: 2 / 3;    /* Na segunda linha, abaixo do dropdown */
            }
            
            /* REVISÃO PARA SIMPLIFICAR O GRID DE HEADERCONTENT EM DESKTOP */
            .accordion-content#headerContent:not(.collapsed) {
                position: relative; /* Para posicionamento absoluto do dropdown se necessário, ou apenas para contexto */
                /* display: block; Resetar para block e usar posicionamento manual ou float para o dropdown */
            }
            .accordion-content#headerContent:not(.collapsed) > .top-action-buttons {
               /* Posicionamento absoluto ou float aqui */
               position: absolute; 
               top: 10px; /* Reduzido de 20px */
               right: 35px; /* Aumentado de 20px para criar mais espaço à direita */
               z-index: 10; /* Para ficar sobre outros elementos se houver sobreposição */
               margin-bottom: 0;
            }
            .accordion-content#headerContent:not(.collapsed) > .form-header-content {
                /* Ocupa o espaço normal, o dropdown está "flutuando" sobre ele */
                /* padding-right: valor_para_nao_sobrepor_dropdown; /* Se o dropdown for muito largo */
                padding-right: 140px; /* Adicionado para evitar que o conteúdo dos campos fique sob o botão Ações */
            }

            .dropdown-container { /* Em desktop, o container do dropdown não ocupa 100% */
                width: auto;
            }
            .dropbtn {
                width: auto; /* Botão ocupa toda a largura em desktop */
            }
            .dropdown-content{
                min-width: 100%; /* Conteúdo do dropdown também ocupa a largura */
                left: 0; /* Alinha à esquerda do container */
            }

            .top-action-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
                justify-content: center;
            }
            .top-action-buttons .btn:last-child {
                margin-bottom: 0;
            }

            .form-header-content .whatsapp-input-group {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-end !important;
                gap: 10px !important;
                width: 100%;
            }

            .form-header-content .whatsapp-input-group input#whatsapp {
                flex-grow: 1;
            }

            .form-header-content .whatsapp-input-group .btn-whatsapp {
                width: auto !important;
                max-width: none !important;
                align-self: flex-end !important;
                margin-bottom: 0 !important;
                flex-shrink: 0;
            }
        }

        #whatsappPreview {
            display: none; /* Esconde o preview do link do WhatsApp */
        }
    </style>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://www.sie.com.br/admin/_upload/2021/10/23/29155/665e0803ea26e.png" alt="Logo SIE" />
        </div>

        <div class="accordion-header" onclick="toggleAccordion()">
            <h1>Acompanhamento - Demandas</h1>
            <svg class="accordion-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 10l5 5 5-5z"/>
            </svg>
        </div>

        <div class="accordion-content" id="headerContent">
            <div class="top-action-buttons">
                <input type="file" id="fileInputTopo" accept=".json" style="display: none;" onchange="carregarJSON(event)">
                
                <div class="dropdown-container">
                    <button onclick="toggleActionsDropdown()" class="btn btn-primary dropbtn">
                        Ações <span class="dropdown-caret">&#9662;</span>
                    </button>
                    <div id="actionsDropdown" class="dropdown-content">
                        <a href="#" onclick="document.getElementById('fileInputTopo').click(); closeActionsDropdown(); return false;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Carregar JSON
                        </a>
                        <a href="#" onclick="salvarJSON(); closeActionsDropdown(); return false;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Salvar JSON
                        </a>
                        <a href="#" onclick="reiniciarVazio(); closeActionsDropdown(); return false;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5 13h14v-2H5v2zm7-12C6.48 1 1 6.48 1 13s5.48 12 12 12 12-5.48 12-12S17.52 1 12 1zm0 22c-5.52 0-10-4.48-10-10S6.48 3 12 3s10 4.48 10 10-4.48 10-10 10z"/>
                            </svg>
                            Reiniciar Vazio
                        </a>
                    </div>
                </div>
            </div>

            <div class="form-header-content">
                <div class="form-group">
                    <label for="dataAtendimento">Data do atendimento:</label>
                    <input type="date" id="dataAtendimento" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="horario">Horário:</label>
                    <input type="time" id="horario" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="responsavel">Acompanhamento</label>
                    <input type="text" id="responsavel" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="endereco">Endereço:</label>
                    <input type="text" id="endereco" class="form-control">
                </div>
                <div class="form-group">
                    <label for="whatsapp">WhatsApp</label>
                    <div class="whatsapp-input-group" style="flex-direction:column;align-items:stretch;gap:8px;">
                        <input type="tel" id="whatsapp" class="form-control" placeholder="(00) 00000-0000" 
                               pattern="\([0-9]{2}\) [0-9]{5}-[0-9]{4}" required>
                        <button class="btn btn-whatsapp" style="width:100%;max-width:220px;align-self:center;" onclick="enviarWhatsApp()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            Enviar
                        </button>
                    </div>
                    <div class="whatsapp-preview" id="whatsappPreview"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2>Serviços a realizar</h2>
            <div class="form-group add-item-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novoServico" class="form-control" placeholder="Adicionar novo serviço...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('servicos')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('servicos')" title="Excluir todos os serviços">X</button>
            </div>
            <div id="servicosContainer">
                <!-- Serviços serão inseridos aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2>Dúvidas a esclarecer</h2>
            <div class="form-group add-item-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novaDuvida" class="form-control" placeholder="Adicionar nova dúvida...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('duvidas')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('duvidas')" title="Excluir todas as dúvidas">X</button>
            </div>
            <div id="duvidasContainer">
                <!-- Dúvidas serão inseridas aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2 id="tituloLuzes" style="cursor:pointer;" onclick="editarTituloLuzes()">Luzes externas</h2>
            <div class="form-group add-item-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novaLuz" class="form-control" placeholder="Adicionar nova luz...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('luzes')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('luzes')" title="Excluir todas as luzes">X</button>
            </div>
            <div id="luzesContainer">
                <!-- Luzes serão inseridas aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2>Outros</h2>
            <div class="form-group add-item-group" style="display:flex;gap:8px;align-items:center;">
                <input type="text" id="novoOutro" class="form-control" placeholder="Adicionar novo item em Outros...">
                <button class="btn btn-primary" type="button" onclick="adicionarItem('outros')">Adicionar</button>
                <button class="btn btn-danger" type="button" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverTodos('outros')" title="Excluir todos os outros">X</button>
            </div>
            <div id="outrosContainer">
                <!-- Outros itens serão inseridos aqui via JavaScript -->
            </div>
        </div>

        <div class="form-section">
            <h2>Observações gerais</h2>
            <div class="form-group">
                <textarea id="observacoes" class="form-control" rows="4"></textarea>
            </div>
        </div>

        <div class="form-section">
            <div class="button-group">
                <div class="button-group-left">
                     <button class="btn btn-primary" onclick="salvarFormulario()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Salvar Formulário
                    </button><br>
                </div>
                <div class="button-group-right">
                    <button class="btn btn-success" onclick="exportarPDF()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Exportar PDF
                    </button><br>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Listas dinâmicas
        let servicos = [
            "Luz da cozinha piscando",
            "Luz automática da escada não acende",
            "Luz do banheiro da frente não acende",
            "Vazamento de água no vaso do banheiro da frente",
            "Trinco da porta da edícula de cima",
            "Registro do banheiro da edícula pingando",
            "Umidade no teto da edícula de cima (conserto do rufo)",
            "Janelas emperrando"
        ];
        let duvidas = [
            "Quando a caixa foi limpa e como acessá-la",
            "Como funciona o gás do chuveiro (não aqueceu)",
            "Pode transformar o chuveiro para elétrico"
        ];
        let luzes = [
            "Luz da churrasqueira (primeira da direita)",
            "Outras luzes de fora, lado esquerdo",
            "Luz do terraço (última à esquerda para quem olha para a rua)"
        ];
        let outros = [
            "Elétrica da edícula ok para instalar chuveiro",
            "Descargas banheiro da frente e edícula (vazamento no mecanismo)"
        ];

        // Variável para o título editável
        let tituloLuzes = 'Luzes externas';

        // Labels editáveis para luzes
        let luzesLabels = ['Lâmpada', 'Fiação', 'Outro'];

        // Exemplo padrão para cada seção
        const exemploServicos = ['Exemplo de serviço...'];
        const exemploDuvidas = ['Exemplo de dúvida...'];
        const exemploLuzes = ['Exemplo de luz...'];
        const exemploOutros = ['Exemplo de outro item...'];

        // Constantes para valores padrão (para maior clareza ao carregar e reiniciar)
        const PADRAO_TITULO_LUZES = 'Luzes externas';
        const PADRAO_LABELS_LUZES = Object.freeze(['Lâmpada', 'Fiação', 'Outro']);

        // Função para criar um item de serviço
        function criarItemServico(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'servicos', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'servicos', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'servicos', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('servicos', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"resolvido\" id=\"resolvido_${descricao}\">
                        <label for=\"resolvido_${descricao}\">Resolvido</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"nao_resolvido\" id=\"nao_resolvido_${descricao}\">
                        <label for=\"nao_resolvido_${descricao}\">Não resolvido</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"orcamento\" id=\"orcamento_${descricao}\">
                        <label for=\"orcamento_${descricao}\">Orçamento necessário</label>
                    </div>
                </div>
            `;
            return div;
        }

        // Função para criar um item de dúvida
        function criarItemDuvida(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'duvidas', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'duvidas', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'duvidas', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('duvidas', ${idx})">X</button>
                    </div>
                </div>
                <textarea class=\"form-control\" rows=\"2\" placeholder="${descricao}"></textarea>
            `;
            return div;
        }

        // Função para criar um item de luz
        function criarItemLuz(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'luzes', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'luzes', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'luzes', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('luzes', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"lampada_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,0)\">${luzesLabels[0]}</span>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"fiacao_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,1)\">${luzesLabels[1]}</span>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"checkbox\" id=\"outro_${descricao}\">
                        <span class=\"editable-checkbox-label\" onclick=\"editarLabelLuz(this,2)\">${luzesLabels[2]}</span>
                    </div>
                </div>
            `;
            return div;
        }

        // Função para criar um item de outros
        function criarItemOutros(descricao, idx) {
            const div = document.createElement('div');
            div.className = 'form-group servico-item';
            div.setAttribute('draggable', 'true');
            div.setAttribute('ondragstart', `dragStart(event, 'outros', ${idx})`);
            div.setAttribute('ondragover', 'dragOver(event)');
            div.setAttribute('ondrop', `dropItem(event, 'outros', ${idx})`);
            div.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span class="editable-label" onclick="editarItem(this, 'outros', ${idx})">${descricao}</span>
                    <div>
                        <button type="button" class="btn btn-danger" style="padding:2px 10px;font-size:18px;background:none;color:#e74c3c;font-weight:bold;border:none;" onclick="confirmarRemoverItem('outros', ${idx})">X</button>
                    </div>
                </div>
                <div class=\"checkbox-group\">
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"sim\" id=\"sim_${descricao}\">
                        <label for=\"sim_${descricao}\">Sim</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"nao\" id=\"nao_${descricao}\">
                        <label for=\"nao_${descricao}\">Não</label>
                    </div>
                    <div class=\"checkbox-item\">
                        <input type=\"radio\" name=\"status_${descricao}\" value=\"obs\" id=\"obs_${descricao}\">
                        <label for=\"obs_${descricao}\">Observações</label>
                    </div>
                </div>
            `;
            return div;
        }

        // Função para atualizar data e hora
        function atualizarDataHora() {
            const agora = new Date();
            
            // Formatar data (YYYY-MM-DD)
            const data = agora.toISOString().split('T')[0];
            
            // Formatar hora (HH:MM)
            const hora = agora.toTimeString().slice(0, 5);
            
            // Atualizar campos
            document.getElementById('dataAtendimento').value = data;
            document.getElementById('horario').value = hora;
        }

        // Função para formatar nome do arquivo
        function formatarNomeArquivo() {
            const responsavel = document.getElementById('responsavel').value.trim();
            const data = document.getElementById('dataAtendimento').value;
            const hora = document.getElementById('horario').value;
            
            // Remover caracteres especiais do nome do responsável
            const nomeFormatado = responsavel
                .replace(/[^a-zA-Z0-9]/g, '_')
                .toLowerCase();
            
            // Formatar data e hora para o nome do arquivo
            const dataFormatada = data.replace(/-/g, '');
            const horaFormatada = hora.replace(/:/g, '');
            
            return `formulario_${nomeFormatado}_${dataFormatada}_${horaFormatada}.json`;
        }

        // Função para alternar o acordeão
        function toggleAccordion() {
            const content = document.getElementById('headerContent');
            const icon = document.querySelector('.accordion-icon');
            content.classList.toggle('collapsed');
            icon.classList.toggle('rotated');
        }

        // Função para adicionar itens dinamicamente
        function adicionarItem(tipo) {
            let inputId, arr;
            if (tipo === 'servicos') {
                inputId = 'novoServico'; arr = servicos;
            } else if (tipo === 'duvidas') {
                inputId = 'novaDuvida'; arr = duvidas;
            } else if (tipo === 'luzes') {
                inputId = 'novaLuz'; arr = luzes;
            } else if (tipo === 'outros') {
                inputId = 'novoOutro'; arr = outros;
            }
            const input = document.getElementById(inputId);
            const valor = input.value.trim();
            if (valor && !arr.includes(valor)) {
                arr.push(valor);
                input.value = '';
                inicializarFormulario();
            }
        }

        // Função para inicializar o formulário
        function inicializarFormulario() {
            const servicosContainer = document.getElementById('servicosContainer');
            const duvidasContainer = document.getElementById('duvidasContainer');
            const luzesContainer = document.getElementById('luzesContainer');
            const outrosContainer = document.getElementById('outrosContainer');

            // Limpar containers
            servicosContainer.innerHTML = '';
            duvidasContainer.innerHTML = '';
            luzesContainer.innerHTML = '';
            outrosContainer.innerHTML = '';

            // NÃO chamar atualizarDataHora() ou setInterval() aqui

            servicos.forEach((servico, idx) => {
                servicosContainer.appendChild(criarItemServico(servico, idx));
            });

            duvidas.forEach((duvida, idx) => {
                duvidasContainer.appendChild(criarItemDuvida(duvida, idx));
            });

            luzes.forEach((luz, idx) => {
                luzesContainer.appendChild(criarItemLuz(luz, idx));
            });

            outros.forEach((outro, idx) => {
                outrosContainer.appendChild(criarItemOutros(outro, idx));
            });

            // Atualizar título da seção Luzes externas
            const h2 = document.getElementById('tituloLuzes');
            if (h2) h2.textContent = tituloLuzes;
        }

        // Função para salvar o formulário como JSON
        function salvarJSON() {
            const formData = coletarDadosFormulario();
            const dataStr = JSON.stringify(formData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = formatarNomeArquivo();
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Função para carregar JSON
        function carregarJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const formData = JSON.parse(e.target.result);
                        preencherFormulario(formData);
                    } catch (error) {
                        alert('Erro ao carregar o arquivo JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        // Função para coletar dados do formulário
        function coletarDadosFormulario() {
            const formData = {
                dataAtendimento: document.getElementById('dataAtendimento').value,
                horario: document.getElementById('horario').value,
                responsavel: document.getElementById('responsavel').value,
                endereco: document.getElementById('endereco').value,
                whatsapp: document.getElementById('whatsapp').value,
                observacoes: document.getElementById('observacoes').value,
                servicos: {},
                duvidas: {},
                luzes: {},
                outros: {},
                listaServicos: servicos,
                listaDuvidas: duvidas,
                listaLuzes: luzes,
                listaOutros: outros,
                tituloLuzes: tituloLuzes,
                luzesLabels: luzesLabels
            };

            // Coletar dados dos serviços
            servicos.forEach(servico => {
                const status = document.querySelector(`input[name="status_${servico}"]:checked`)?.value;
                formData.servicos[servico] = status;
            });

            // Coletar dados das dúvidas
            duvidas.forEach(duvida => {
                const textarea = document.querySelector(`textarea[placeholder="${duvida}"]`);
                formData.duvidas[duvida] = textarea ? textarea.value : '';
            });

            // Coletar dados das luzes
            luzes.forEach(luz => {
                formData.luzes[luz] = {
                    lampada: document.getElementById(`lampada_${luz}`)?.checked || false,
                    fiacao: document.getElementById(`fiacao_${luz}`)?.checked || false,
                    outro: document.getElementById(`outro_${luz}`)?.checked || false
                };
            });

            // Coletar dados dos outros
            outros.forEach(outro => {
                const status = document.querySelector(`input[name="status_${outro}"]:checked`)?.value;
                formData.outros[outro] = status;
            });

            return formData;
        }

        // Função para preencher o formulário com dados carregados
        function preencherFormulario(formData) {
            // 1. Atualizar as listas de itens e variáveis de personalização a partir do formData
            servicos = (formData.listaServicos && formData.listaServicos.length > 0) ? [...formData.listaServicos] : [...exemploServicos];
            duvidas =  (formData.listaDuvidas && formData.listaDuvidas.length > 0) ? [...formData.listaDuvidas] : [...exemploDuvidas];
            luzes =    (formData.listaLuzes   && formData.listaLuzes.length > 0)   ? [...formData.listaLuzes]   : [...exemploLuzes];
            outros =   (formData.listaOutros  && formData.listaOutros.length > 0)  ? [...formData.listaOutros]  : [...exemploOutros];

            tituloLuzes = formData.tituloLuzes || PADRAO_TITULO_LUZES;
            luzesLabels = (formData.luzesLabels && Array.isArray(formData.luzesLabels) && formData.luzesLabels.length === 3) 
                            ? [...formData.luzesLabels] 
                            : [...PADRAO_LABELS_LUZES];
            
            // 2. Preencher campos do cabeçalho (eles não dependem da estrutura dinâmica)
            document.getElementById('dataAtendimento').value = formData.dataAtendimento || '';
            document.getElementById('horario').value = formData.horario || '';
            document.getElementById('responsavel').value = formData.responsavel || '';
            document.getElementById('endereco').value = formData.endereco || '';
            document.getElementById('whatsapp').value = formData.whatsapp || '';
            atualizarPreviewWhatsApp();
            document.getElementById('observacoes').value = formData.observacoes || '';

            // 3. Chamar inicializarFormulario() PARA CONSTRUIR O HTML dos itens dinâmicos
            inicializarFormulario();

            // 4. AGORA, com o HTML dos itens já construído, preencher os valores (status, textareas, checkboxes)
            if (formData.servicos) {
                Object.entries(formData.servicos).forEach(([servicoNome, status]) => {
                    const radio = document.querySelector(`input[name="status_${servicoNome}"][value="${status}"]`);
                    if (radio) radio.checked = true;
                });
            }

            if (formData.duvidas) {
                Object.entries(formData.duvidas).forEach(([duvidaNome, resposta]) => {
                    const textarea = document.querySelector(`textarea[placeholder="${duvidaNome}"]`);
                    if (textarea) textarea.value = resposta;
                });
            }

            if (formData.luzes) {
                Object.entries(formData.luzes).forEach(([luzNome, dados]) => {
                    if (dados.lampada && document.getElementById(`lampada_${luzNome}`)) document.getElementById(`lampada_${luzNome}`).checked = true;
                    if (dados.fiacao && document.getElementById(`fiacao_${luzNome}`)) document.getElementById(`fiacao_${luzNome}`).checked = true;
                    if (dados.outro && document.getElementById(`outro_${luzNome}`)) document.getElementById(`outro_${luzNome}`).checked = true;
                });
            }

            if (formData.outros) {
                Object.entries(formData.outros).forEach(([outroNome, status]) => {
                    const radio = document.querySelector(`input[name="status_${outroNome}"][value="${status}"]`);
                    if (radio) radio.checked = true;
                });
            }
        }

        // Função para salvar o formulário
        function salvarFormulario() {
            const formData = coletarDadosFormulario();
            localStorage.setItem('formularioServicos', JSON.stringify(formData));
            alert('Formulário salvo com sucesso!');
        }

        // Função para exportar PDF
        function exportarPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const formData = coletarDadosFormulario();
                const doc = new jsPDF();

                const margin = 18;
                let y = margin;
                const pageWidth = doc.internal.pageSize.getWidth() - (margin * 2);
                const pageHeight = doc.internal.pageSize.getHeight();
                const usablePageHeight = pageHeight - margin; 

                const menuFontSize = 9;
                const menuSeparator = "  |  ";

                function drawHorizontalMenu(docInstance, targetY, onPageNum) {
                    docInstance.setFontSize(menuFontSize);
                    docInstance.setFont('helvetica', 'normal');
                    docInstance.setTextColor(0, 0, 255); // Cor de link azul

                    let luzesMenuText = formData.tituloLuzes || PADRAO_TITULO_LUZES;
                    if (docInstance.getTextWidth(luzesMenuText) > pageWidth / 4) { // Heurística de largura para "Luzes"
                        luzesMenuText = "Luzes";
                    }

                    const menuConfig = [
                        { text: "Dados Gerais", page: 1 },
                        { text: "Serviços", page: 1 },
                        { text: "Dúvidas", page: 2 },
                        { text: luzesMenuText, page: 3 },
                        { text: "Outros", page: 4 },
                        { text: "Observações", page: 5 }
                    ];

                    let currentX = margin;
                    let totalTextWidth = 0;
                    const itemWidths = [];
                    const separatorWidth = docInstance.getTextWidth(menuSeparator);

                    menuConfig.forEach((item, index) => {
                        const textWidth = docInstance.getTextWidth(item.text);
                        itemWidths.push(textWidth);
                        totalTextWidth += textWidth;
                        if (index < menuConfig.length - 1) {
                            totalTextWidth += separatorWidth;
                        }
                    });

                    currentX = (docInstance.internal.pageSize.getWidth() - totalTextWidth) / 2; // Centralizar
                    
                    docInstance.setPage(onPageNum); // Assegurar que estamos desenhando na página correta

                    menuConfig.forEach((item, index) => {
                        docInstance.textWithLink(item.text, currentX, targetY, { pageNumber: item.page });
                        currentX += itemWidths[index];

                        if (index < menuConfig.length - 1) {
                            docInstance.text(menuSeparator, currentX, targetY);
                            currentX += separatorWidth;
                        }
                    });
                    docInstance.setTextColor(0,0,0); // Resetar cor do texto para preto
                }

                function checkPageBreak(requiredHeight = 0) {
                    if (y + requiredHeight > usablePageHeight && y > margin +1 ) {
                        doc.addPage();
                        y = margin; 
                        return true; 
                    }
                    return false;
                }

                function addTitle(text, fontSize, style, spaceBefore, spaceAfter) {
                    y += spaceBefore;
                    doc.setFontSize(fontSize);
                    doc.setFont('helvetica', style);
                    const textWidth = doc.getTextWidth(text);
                    const textX = (doc.internal.pageSize.getWidth() - textWidth) / 2; 
                    doc.text(text, textX, y);
                    y += spaceAfter; 
                }

                function addSectionHeader(text, spaceBefore, spaceAfter) {
                    y += spaceBefore; 
                    doc.setFontSize(13);
                    doc.setFont('helvetica', 'bold');
                    doc.text(text, margin, y);
                    y += spaceAfter; 
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                }

                function addItemText(fullText, indent, makeValueItalic = false, makeValueGray = false, makeEntireTextGray = false) {
                    const blackColor = '#000000';
                    const darkGrayColor = '#4A4A4A';
                    const itemLineHeight = 7;
                    const interItemSpaceTotal = (!makeEntireTextGray || indent !== 0) ? 2 : 0;

                    const lines = doc.splitTextToSize(fullText, pageWidth - indent);
                    
                    lines.forEach(line => {
                        checkPageBreak(itemLineHeight);
                        
                        if (makeEntireTextGray) {
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(darkGrayColor);
                            doc.text(line, margin + indent, y);
                        } else {
                            const separator = ': ';
                            const separatorIndex = line.lastIndexOf(separator);

                            if (separatorIndex !== -1 && (makeValueGray || makeValueItalic)) {
                                const prefixText = line.substring(0, separatorIndex + separator.length);
                                const valueText = line.substring(separatorIndex + separator.length);

                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(blackColor);
                                doc.text(prefixText, margin + indent, y);
                                const prefixWidth = doc.getTextWidth(prefixText);

                                doc.setFont('helvetica', makeValueItalic ? 'italic' : 'normal');
                                doc.setTextColor(makeValueGray ? darkGrayColor : blackColor);
                                doc.text(valueText, margin + indent + prefixWidth, y);
                            } else if (separatorIndex === -1 && (makeValueGray || makeValueItalic)) {
                                doc.setFont('helvetica', makeValueItalic ? 'italic' : 'normal');
                                doc.setTextColor(makeValueGray ? darkGrayColor : blackColor);
                                doc.text(line, margin + indent, y);
                            } else {
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(blackColor);
                                doc.text(line, margin + indent, y);
                            }
                        }
                        y += itemLineHeight; 
                    });

                    if (interItemSpaceTotal > 0) {
                         y += interItemSpaceTotal; 
                    }
                    doc.setTextColor(blackColor); 
                    doc.setFont('helvetica', 'normal'); 
                }

                const logoUrl = 'https://www.sie.com.br/admin/_upload/2021/10/23/29155/665e0803ea26e.png';
                const img = new Image();
                img.crossOrigin = 'Anonymous';

                img.onload = function() {
                    try {
                        // --- PÁGINA 1 --- 
                        const aspectRatio = img.width / img.height;
                        const logoWidth = pageWidth * 0.0875; 
                        const logoHeight = logoWidth / aspectRatio; 
                        doc.addImage(img, 'PNG', margin, margin, logoWidth, logoHeight);

                        const mainTitleText = 'Formulário de Acompanhamento - Serviços';
                        const titleFontSize = 14;
                        const ptToMm = 25.4 / 72; 
                        doc.setFontSize(titleFontSize);
                        doc.setFont('helvetica', 'bold');
                        const titleX = margin + logoWidth + 10; 
                        const titleMaxWidth = doc.internal.pageSize.getWidth() - titleX - margin; 
                        const titleLines = doc.splitTextToSize(mainTitleText, titleMaxWidth);
                        if (titleLines.length > 0) {
                            const logoCenterY_mm = margin + logoHeight / 2;
                            const titleLineHeightMm = (titleFontSize * 1.15) * ptToMm;
                            const titleBlockHeightMm = titleLines.length * titleLineHeightMm;
                            const topOfTitleBlockMm = logoCenterY_mm - (titleBlockHeightMm / 2);
                            let titleCurrentBaselineY_mm = topOfTitleBlockMm + (titleFontSize * 0.8 * ptToMm); 
                            for (const line of titleLines) {
                                doc.text(line, titleX, titleCurrentBaselineY_mm);
                                titleCurrentBaselineY_mm += titleLineHeightMm;
                            }
                            const titleBlockBottomEdgeMm = topOfTitleBlockMm + titleBlockHeightMm;
                            y = Math.max(margin + logoHeight, titleBlockBottomEdgeMm) + 15; 
                        } else {
                            y = margin + logoHeight + 15;
                        }

                        // --- MENU HORIZONTAL TOPO PÁGINA 1 ---
                        const yMenuP1 = y; // y está posicionado após o título
                        drawHorizontalMenu(doc, yMenuP1, 1);
                        y = yMenuP1 + menuFontSize + 5; // Atualizar y para o conteúdo abaixo do menu
                        // --- FIM MENU HORIZONTAL TOPO PÁGINA 1 ---

                        // O spaceBefore do primeiro addSectionHeader (Dados Gerais) é 0, pois y já está posicionado após o menu horizontal.
                        addSectionHeader('Dados Gerais', 0, 10); 
                        addItemText(`Data do atendimento: ${formData.dataAtendimento || ''}`, 0, false, true, false);
                        addItemText(`Horário: ${formData.horario || ''}`, 0, false, true, false);
                        addItemText(`Endereço: ${formData.endereco || ''}`, 0, false, true, false); 
                        addItemText(`Responsável: ${formData.responsavel || ''}`, 0, false, true, false);
                        addItemText(`WhatsApp: ${formData.whatsapp || ''}`, 0, false, true, false);

                        addSectionHeader('Serviços a realizar', 12, 10); 
                        Object.entries(formData.servicos || {}).forEach(([serv, status]) => {
                            addItemText(`- ${serv}: ${status || 'Pendente'}`, 5, true, true, false);
                        });

                        // --- PÁGINA 2: Dúvidas --- 
                        doc.addPage();
                        y = margin;
                        drawHorizontalMenu(doc, y, 2); // Desenha menu no topo da Pág 2
                        y += menuFontSize + 5; // Ajusta y para conteúdo abaixo do menu
                        addSectionHeader('Dúvidas a esclarecer', 10, 10); 
                        Object.entries(formData.duvidas || {}).forEach(([duv, resp]) => {
                            addItemText(`- ${duv}: ${resp || ''}`, 5, false, true, false);
                        });

                        // --- PÁGINA 3: Luzes --- 
                        doc.addPage();
                        y = margin; 
                        drawHorizontalMenu(doc, y, 3); // Desenha menu no topo da Pág 3
                        y += menuFontSize + 5; // Ajusta y
                        addSectionHeader((formData.tituloLuzes || PADRAO_TITULO_LUZES), 10, 10); 
                        Object.entries(formData.luzes || {}).forEach(([luzDesc, statusObj]) => {
                            const currentLabels = formData.luzesLabels || PADRAO_LABELS_LUZES;
                            addItemText(`- ${luzDesc}:`, 5, false, false, false);

                            const luzSubItems = [
                                { label: currentLabels[0], statusKey: 'lampada' },
                                { label: currentLabels[1], statusKey: 'fiacao' },
                                { label: currentLabels[2], statusKey: 'outro' }
                            ];

                            luzSubItems.forEach(item => {
                                const valorText = statusObj[item.statusKey] ? 'Sim' : 'Não';
                                const fullLineText = `${item.label}: ${valorText}`;
                                addItemText(fullLineText, 10, true, true, false); 
                            });
                            
                            y += 4; 
                        });

                        // --- PÁGINA 4: Outros --- 
                        doc.addPage();
                        y = margin;
                        drawHorizontalMenu(doc, y, 4); // Desenha menu no topo da Pág 4
                        y += menuFontSize + 5; // Ajusta y
                        addSectionHeader('Outros', 10, 10); 
                        Object.entries(formData.outros || {}).forEach(([outro, status]) => {
                            addItemText(`- ${outro}: ${status || 'Pendente'}`, 5, true, true, false);
                        });

                        // --- PÁGINA 5: Observações --- 
                        doc.addPage();
                        y = margin;
                        drawHorizontalMenu(doc, y, 5); // Desenha menu no topo da Pág 5
                        y += menuFontSize + 5; // Ajusta y
                        addSectionHeader('Observações gerais', 10, 10); 
                        addItemText(formData.observacoes || 'Nenhuma observação.', 0, false, false, true);

                        // --- ADICIONAR APENAS COPYRIGHT NOS RODAPÉS ANTES DE SALVAR ---
                        const totalPages = doc.internal.getNumberOfPages();
                        const copyrightText = "© 2025 - Freenatwork Solutions | FNW Digital | Alex Sobral. Todos os direitos reservados";
                        const copyrightFontSize = 8;
                        const copyrightColor = '#888888'; // Cinza claro
                        const copyrightMarginBottom = margin; // Posicionar na base da margem inferior

                        for (let i = 2; i <= totalPages; i++) { 
                            doc.setPage(i); // Certificar que estamos na página correta

                            // Adicionar copyright
                            doc.setFontSize(copyrightFontSize);
                            doc.setTextColor(copyrightColor);
                            const copyrightYpos = pageHeight - copyrightMarginBottom + (copyrightFontSize * 0.35); // Ajuste fino para alinhar base da fonte

                            // Centralizar copyright em todas as páginas aplicáveis (2 em diante)
                            const textWidth = doc.getTextWidth(copyrightText);
                            const copyrightXpos = (doc.internal.pageSize.getWidth() - textWidth) / 2; // Centralizar na página
                            doc.text(copyrightText, copyrightXpos, copyrightYpos);
                            
                            doc.setTextColor(0,0,0); // Resetar cor do texto para preto para outras operações
                        }
                        // --- FIM RODAPÉS ---

                        doc.save('formulario_servicos.pdf');

                    } catch (pdfError) {
                        console.error('Erro ao gerar o conteúdo do PDF:', pdfError);
                        alert('Ocorreu um erro ao gerar o conteúdo do PDF.');
                    }
                };

                img.onerror = function() {
                    console.error('Erro ao carregar a imagem da logo.');
                    alert('Não foi possível carregar a logo. O PDF será gerado com erros de layout ou sem a logo.');
                    // Fallback muito simplificado para evitar erros complexos aqui
                    try {
                        y = margin;
                        addTitle('Formulário de Acompanhamento - Serviços', 14, 'bold', 10, 15);
                        doc.text('ERRO: A logo não pôde ser carregada.', margin, y); y+= 10;
                        doc.text('Continuando com os dados...', margin, y); y+=10;

                        // Tentar renderizar o conteúdo de forma simplificada, sem a estrutura de paginação original
                        addSectionHeader('Dados Gerais', 0, 10); 
                        addItemText(`Data: ${formData.dataAtendimento || ''}`, 0, false, true, false);
                        addSectionHeader('Serviços', 12, 10);
                        Object.keys(formData.servicos || {}).forEach(k => addItemText(k,0));
                        addSectionHeader('Dúvidas', 12, 10);
                        Object.keys(formData.duvidas || {}).forEach(k => addItemText(k,0));
                        
                        // Adicionar nova página manualmente aqui se quiser separar o resto
                        doc.addPage(); y = margin;
                        addSectionHeader('Luzes', 10,10);
                        Object.keys(formData.luzes || {}).forEach(k => addItemText(k,0));
                        addSectionHeader('Outros', 12,10);
                        Object.keys(formData.outros || {}).forEach(k => addItemText(k,0));
                        addSectionHeader('Observações',12,10);
                        addItemText(formData.observacoes || '',0,false,false,true);

                        doc.save('formulario_servicos_fallback.pdf');
                    } catch (fallbackError) {
                        console.error('Erro ao gerar PDF de fallback:', fallbackError);
                        alert('Ocorreu um erro crítico ao tentar gerar o PDF de fallback.');
                    }
                };

                img.src = logoUrl;

            } catch (initError) {
                console.error('Erro ao inicializar o jsPDF ou coletar dados:', initError);
                alert('Ocorreu um erro ao preparar a exportação para PDF.');
            }
        }

        // Função para carregar do localStorage ao iniciar
        function carregarDoLocalStorage() {
            const savedData = localStorage.getItem('formularioServicos');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    preencherFormulario(formData);
                } catch (error) {
                    console.error('Erro ao carregar dados do localStorage:', error);
                    alert('Erro ao carregar dados do localStorage. O formulário pode não ter sido carregado corretamente.');
                }
            }
        }

        // Função para formatar número de WhatsApp
        function formatarWhatsApp(numero) {
            return numero.replace(/\D/g, '');
        }

        // Função para validar número de WhatsApp
        function validarWhatsApp(numero) {
            const numeroLimpo = formatarWhatsApp(numero);
            return numeroLimpo.length >= 10 && numeroLimpo.length <= 11;
        }

        // Função para atualizar preview do WhatsApp
        function atualizarPreviewWhatsApp() {
            const numero = document.getElementById('whatsapp').value;
            const numeroLimpo = formatarWhatsApp(numero);
            const preview = document.getElementById('whatsappPreview');
            
            if (validarWhatsApp(numero)) {
                preview.textContent = `Link do WhatsApp: https://wa.me/55${numeroLimpo}`;
                preview.style.color = 'var(--success-color)';
            } else {
                preview.textContent = 'Número inválido';
                preview.style.color = 'var(--danger-color)';
            }
        }

        // Função para enviar WhatsApp
        function enviarWhatsApp() {
            const numero = document.getElementById('whatsapp').value;
            const numeroLimpo = formatarWhatsApp(numero);
            
            if (validarWhatsApp(numero)) {
                const formData = coletarDadosFormulario();
                const mensagem = `Formulário de Serviços\n\n` +
                    `Data: ${formData.dataAtendimento}\n` +
                    `Horário: ${formData.horario}\n` +
                    `Responsável: ${formData.responsavel}\n` +
                    `Endereço: ${formData.endereco}\n\n` +
                    `Observações: ${formData.observacoes}`;
                
                const url = `https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(mensagem)}`;
                window.open(url, '_blank');
            } else {
                alert('Por favor, insira um número de WhatsApp válido');
            }
        }

        // Adicionar evento de input para o campo de WhatsApp
        document.getElementById('whatsapp').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 2) {
                value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
            }
            if (value.length > 9) {
                value = `${value.slice(0, 9)}-${value.slice(9)}`;
            }
            
            e.target.value = value;
            atualizarPreviewWhatsApp();
        });

        // Função de confirmação antes de remover
        function confirmarRemoverItem(tipo, idx) {
            const acao = prompt('Digite 1 para excluir apenas este item, 2 para excluir TODOS os itens, ou qualquer outra tecla para cancelar.');
            if (acao === '1') {
                if (confirm('Tem certeza que deseja excluir este item?')) {
                    removerItem(tipo, idx);
                }
            } else if (acao === '2') {
                confirmarRemoverTodos(tipo);
            }
        }

        function confirmarRemoverTodos(tipo) {
            let msg = 'Tem certeza que deseja excluir TODOS os itens desta seção?';
            if (confirm(msg)) {
                removerTodos(tipo);
            }
        }

        function removerTodos(tipo) {
            if (tipo === 'servicos') servicos = [];
            else if (tipo === 'duvidas') duvidas = [];
            else if (tipo === 'luzes') luzes = [];
            else if (tipo === 'outros') outros = [];
            inicializarFormulario();
        }

        // RemoverItem agora não precisa mais de prompt
        function removerItem(tipo, idx) {
            let arr;
            if (tipo === 'servicos') arr = servicos;
            else if (tipo === 'duvidas') arr = duvidas;
            else if (tipo === 'luzes') arr = luzes;
            else if (tipo === 'outros') arr = outros;
            arr.splice(idx, 1);
            inicializarFormulario();
        }

        // Drag and drop handlers
        let dragSrcIdx = null;
        let dragSrcTipo = null;
        function dragStart(e, tipo, idx) {
            dragSrcIdx = idx;
            dragSrcTipo = tipo;
            e.dataTransfer.effectAllowed = 'move';
        }
        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        function dropItem(e, tipo, idx) {
            e.preventDefault();
            if (dragSrcTipo === tipo && dragSrcIdx !== null && dragSrcIdx !== idx) {
                let arr;
                if (tipo === 'servicos') arr = servicos;
                else if (tipo === 'duvidas') arr = duvidas;
                else if (tipo === 'luzes') arr = luzes;
                else if (tipo === 'outros') arr = outros;
                const item = arr.splice(dragSrcIdx, 1)[0];
                arr.splice(idx, 0, item);
                inicializarFormulario();
            }
            dragSrcIdx = null;
            dragSrcTipo = null;
        }

        // Edição inline
        function editarItem(span, tipo, idx) {
            const valorAtual = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = valorAtual;
            input.className = 'form-control';
            input.style.display = 'inline-block';
            input.style.width = 'auto';
            input.style.maxWidth = '300px';
            input.onblur = function() { salvarEdicao(this, tipo, idx); };
            input.onkeydown = function(e) { if (e.key === 'Enter') { this.blur(); } };
            span.replaceWith(input);
            input.focus();
        }
        function salvarEdicao(input, tipo, idx) {
            let arr;
            if (tipo === 'servicos') arr = servicos;
            else if (tipo === 'duvidas') arr = duvidas;
            else if (tipo === 'luzes') arr = luzes;
            else if (tipo === 'outros') arr = outros;
            arr[idx] = input.value.trim() || arr[idx];
            inicializarFormulario();
        }

        // Função para editar o título da seção Luzes externas
        function editarTituloLuzes() {
            const h2 = document.getElementById('tituloLuzes');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = tituloLuzes;
            input.className = 'form-control';
            input.style.fontSize = '1.5em';
            input.style.fontWeight = 'bold';
            input.onblur = function() { salvarTituloLuzes(this.value); };
            input.onkeydown = function(e) { if (e.key === 'Enter') { this.blur(); } };
            h2.replaceWith(input);
            input.focus();
        }
        function salvarTituloLuzes(valor) {
            tituloLuzes = valor.trim() || 'Luzes externas';
            const input = document.querySelector('input.form-control[style*="font-size: 1.5em"]');
            if (input) {
                const h2 = document.createElement('h2');
                h2.id = 'tituloLuzes';
                h2.style.cursor = 'pointer';
                h2.onclick = editarTituloLuzes;
                h2.textContent = tituloLuzes;
                input.replaceWith(h2);
            }
        }

        // Função para reiniciar o formulário vazio
        function reiniciarVazio() {
            if (confirm('Tem certeza que deseja reiniciar o formulário vazio? Todos os dados serão perdidos!')) {
                servicos = [...exemploServicos];
                duvidas = [...exemploDuvidas];
                luzes = [...exemploLuzes];
                outros = [...exemploOutros];
                // Usar as constantes padrão ao reiniciar
                tituloLuzes = PADRAO_TITULO_LUZES;
                luzesLabels = [...PADRAO_LABELS_LUZES];
                
                document.getElementById('dataAtendimento').value = '';
                document.getElementById('horario').value = '';
                document.getElementById('responsavel').value = '';
                document.getElementById('endereco').value = '';
                document.getElementById('whatsapp').value = '';
                document.getElementById('observacoes').value = '';
                inicializarFormulario();
            }
        }

        // Labels editáveis para luzes - removida a inicialização aqui, pois já é feita no topo.
        // let luzesLabels = [...exemploLabelsLuzes]; 

        function editarLabelLuz(span, idx) {
            const valorAtual = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = valorAtual;
            input.className = 'form-control';
            input.style.display = 'inline-block';
            input.style.width = 'auto';
            input.style.maxWidth = '120px';
            input.onblur = function() { salvarLabelLuz(this, idx); };
            input.onkeydown = function(e) { if (e.key === 'Enter') { this.blur(); } };
            span.replaceWith(input);
            input.focus();
        }
        function salvarLabelLuz(input, idx) {
            luzesLabels[idx] = input.value.trim() || PADRAO_LABELS_LUZES[idx]; // Recorrer ao padrão se deixar em branco
            inicializarFormulario();
        }

        // Atualizar a inicialização
        window.onload = function() {
            // 1. Atualizar data e hora uma vez e configurar o intervalo
            atualizarDataHora(); 
            setInterval(atualizarDataHora, 60000);

            // 2. Inicializar a estrutura do formulário (listas de itens)
            inicializarFormulario(); 

            // 3. Carregar dados do localStorage, se houver
            carregarDoLocalStorage(); 

            // 4. Atualizar o preview do WhatsApp com base no que foi carregado ou está nos campos
            atualizarPreviewWhatsApp(); 
        };

        function toggleActionsDropdown() {
            document.getElementById("actionsDropdown").classList.toggle("show");
        }

        function closeActionsDropdown() {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }

        // Fecha o dropdown se clicar fora dele
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn') && !event.target.closest('.dropbtn')) { // Modificado para incluir elementos dentro do dropbtn (como o span e svg)
                closeActionsDropdown();
            }
        }
    </script>
</body>
</html> 
